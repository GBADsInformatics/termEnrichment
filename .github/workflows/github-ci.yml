on:
  push:
    branches: [ "main" , "master" ]

  workflow_dispatch:
  
jobs:
  commit-hash:
    name: Commit SHA
    runs-on: ubuntu-latest
    outputs:
      sha7: ${{ steps.commit-hash.outputs.sha7 }}
    steps:
      - name: Get Commit SHA
        id: commit-hash
        run: echo "sha7=$(echo ${GITHUB_SHA} | cut -c1-7)" >> "$GITHUB_OUTPUT"

  docker:
    uses: GBADsInformatics/DevopsWorkflows/.github/workflows/docker.yml@v2.0
    secrets: inherit
    with:
      IMAGE_NAME: term-enrichment-api
      CONTEXT: ./GBADS_TermEnrichment
      DOCKERFILE: ./GBADS_TermEnrichment/Dockerfile

  aws:
    needs: [commit-hash, docker]
    uses: GBADsInformatics/DevopsWorkflows/.github/workflows/aws.yml@v2.0
    secrets:
      template-input: >-
        ApplicationName=term-enrich-api,
        DockerURI=gbadsinformatics/term-enrichment-api:${{ needs.commit-hash.outputs.sha7 }},
        BaseURL=/enrichment-api,
        ListenerRulePriority=27,
        MYSQLHOST=${{ vars.MYSQL_HOST }},
        MYSQLDATABASE=${{ vars.MYSQL_DATABASE }},
        MYSQLUSER=${{ vars.MYSQL_USER }},
        MYSQLPASSWORD=${{ secrets.MYSQL_PASSWORD }},
        APIUSER=${{ vars.API_USER }},
        APIPASSWORD=${{ secrets.API_PASSWORD }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    with:
      stack-name: term-enrich-api-stack
      stack-update-timeout: 5
      AWS_REGION: ca-central-1
